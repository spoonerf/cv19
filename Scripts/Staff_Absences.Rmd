---
date: "`r Sys.Date()`"
output: pdf_document
params:
  hospital: "NDDH"
  in_file: "Staff_Absences_NDDH_20200408.xlsx"
  end_date: !r as.Date("2020-04-16")
  in_dir: "C:/Users/Fiona/University of Exeter/COVID19 Modelling - Documents/Staff_Absences/Data_from_Claire/"
  out_dir: !r paste0("C:/Users/Fiona/University of Exeter/COVID19 Modelling - Documents/Staff_Absences/Reports_and_Results/Outputs_",format(Sys.Date(), "%Y%m%d"), "/") 
  fig_width: 11.75
  fig_height: 7
  image_ppi: 1000
title: "Staff Absences"
subtitle: "`r params$hospital`"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width = params$fig_width, fig.height = params$fig_height)
```

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(here)
library(janitor)
library(knitr)
library(patchwork)
library(tidyr)

```

```{r}
load(paste0(params$in_dir, "Devon_projection.RData"))
scen_in <- Devon_projection

if (!dir.exists(params$out_dir)){
  dir.create(params$out_dir, recursive = T)
}

```

#### Modelled Forecasts\
Staff Absences for `r params$hospital` under four modelled forecasts:

1. **NationalRt75** - based on outputs from the Imperial College model. The average (median) output from that model doesn’t seem to align to cases seen in NDDH which appear higher and closer to the Rt75 (the 75% percentile of the output distribution). This has been a good predictor of the number of cases over the past week
 
2. **DevonRt50** – based on outputs from Rob Challen’s model that produces an Rt for each unitary authority. These results are based on using Rt50, the centre (median) of the distribution of outputs from the model that appears to track the cases in Devon well.

3. **DevonRt97.5** – based on outputs from Rob Challen’s model that produces an Rt for each unitary authority. These results are based on using the upper value (of the 95% interval for distribution of outputs) from the model.

4. **DevonRt2.5** – based on outputs from Rob Challen’s model that produces an Rt for each unitary authority. These results are based on using the lower value (of the 95% interval for distribution of outputs) from the model.




```{r}
Daily_Absences_All_Staff <-
  read_excel(paste0(
    params$in_dir,
    params$in_file
  ),
    "Daily_Absences_All_Staff",
    col_names = TRUE
  ) %>% 
  mutate(Staff_Absences_Perc = Staff_Absences_Perc/100, 
         Staff_Absences_Covid_Perc = Staff_Absences_Covid_Perc/100,
         Staff_Absences_NoCovid_Perc = Staff_Absences_Perc - Staff_Absences_Covid_Perc, 
         Date = as.Date(Date))

first_date <- as.Date(max(Daily_Absences_All_Staff$Date))


```


```{r Scenario Scaling Function}
scenario_scaler <- function(scenario_name, name_out,real_data, start_date_model, end_date_model){
  
  scen <- scen_in %>% 
    select(date, {{scenario_name}}) %>% 
    filter(date >= {{start_date_model}} & date <= {{end_date_model}}) %>% 
    mutate(scen_lag = c(NA, head({{scenario_name}},-1)))
  
  scen$scen_lag[1] <- scen$scen_lag[2]
  
  scen <- scen %>% 
    mutate(scen_pcnt = {{scenario_name}}/scen_lag, 
           scen_rt = cumprod(scen_pcnt),
           scen_model_pred = tail(real_data,1) * scen_rt) 
  
  df_out <- data.frame(dates_out = seq(start_date_model - (length(real_data)-1), end_date_model, by = "day"),
                       pred_out = c(head(real_data,-1), scen$scen_model_pred),
                       model_name = name_out)
  return(df_out)  
  
}

```




```{r Scaling scenarios}
dev2_5 <- scenario_scaler(scenario_name = Rob2_5,
                name_out = "Dev2.5",
                real_data = Daily_Absences_All_Staff$Staff_Absences_Covid_Perc,
                start_date_model = first_date, 
                end_date_model = params$end_date)

dev50 <- scenario_scaler(scenario_name = Rob50,
                name_out = "Dev50",
                real_data = Daily_Absences_All_Staff$Staff_Absences_Covid_Perc,
                start_date_model = first_date, 
                end_date_model = params$end_date)

dev97_5 <- scenario_scaler(scenario_name = Rob97_5,
                name_out = "Dev97.5",
                real_data = Daily_Absences_All_Staff$Staff_Absences_Covid_Perc,
                start_date_model = first_date, 
                end_date_model = params$end_date)

nat75 <- scenario_scaler(scenario_name = Rt75,
                name_out = "Nat75",
                real_data = Daily_Absences_All_Staff$Staff_Absences_Covid_Perc,
                start_date_model = first_date, 
                end_date_model = params$end_date)

cov_long <- rbind(dev2_5, dev50, dev97_5, nat75)
colnames(cov_long) <- c("date", "value", "name")

```


```{r, eval = FALSE}

ggplot(cov_long %>% 
         filter(date > as.Date("2020-03-19")),
       aes(
         x = date,
         y = value,
         group = name,
         col = name
       )) +
  geom_line(aes(
    linetype = name,
    color = name,
    size = name
  )) +
  geom_point(data = cov_long %>% 
               filter(date <= first_date &
                      date >as.Date("2020-03-19")),
             col = "black") +
  ggtitle(paste0("Rt for ", params$hospital)) +
  scale_linetype_manual(values = c("twodash", "solid", "dotted", "solid")) +
  scale_color_manual(values = c(rep("#F8766D", 3), "#00BFC4")) +
  scale_size_manual(values = c(1, 1.5, 1, 1.5))


```
\newpage
#### Staff Absence Data\
Percentages of `r params$hospital` staff absences from `r min(Daily_Absences_All_Staff$Date)` to `r max(Daily_Absences_All_Staff$Date)`


```{r Table of absences %, eval = TRUE}
kable(Daily_Absences_All_Staff %>%
        select(Date, Staff_Absences_Perc,Staff_Absences_Covid_Perc,Staff_Absences_NoCovid_Perc) %>% 
        mutate(Staff_Absences_Perc = round(Staff_Absences_Perc *100,2),
               Staff_Absences_Covid_Perc = round(Staff_Absences_Covid_Perc * 100,2),
               Staff_Absences_NoCovid_Perc = round(Staff_Absences_NoCovid_Perc *100,2)), col.names = c("Date", "Total Staff Absences (%)", "Staff Absences due to COVID-19 (%)", "Other Staff Absences (%)"))

```


```{r}

Number_Staff_By_Group <- read_excel(paste0(params$in_dir,params$in_file), "Number_Staff_By_Group", col_names = TRUE) %>% 
  select(Group, FTE, Number_Staff) %>% 
  filter(!Group %in% c("Students", "Total"))

Number_Staff_By_Group$FTE <- as.numeric(Number_Staff_By_Group$FTE)

Number_Staff_By_Group$Number_Staff <- as.numeric(Number_Staff_By_Group$Number_Staff)

staff_num <- sum(Number_Staff_By_Group$Number_Staff)
group_max <- max(Number_Staff_By_Group$Number_Staff)

```


```{r Group Weights}
staff_weights <-
  read_excel(paste0(params$in_dir, params$in_file), "Absences_By_Group", col_names = TRUE) %>%
  filter(!Group %in% c("Total", "Students")) %>%
  drop_na() %>%
  left_join(., Number_Staff_By_Group, by = "Group") %>%
  mutate(
    Staff_Absences_Perc = as.numeric(Staff_Absences_Perc) / 100,
    Staff_Absences_Covid_Perc = as.numeric(Staff_Absences_Covid_Perc)/100,
    Staff_Absences_No_Covid_Perc = Staff_Absences_Perc - Staff_Absences_Covid_Perc,
    Num_Absent_Cov = Staff_Absences_Covid_Perc * Number_Staff,
    Num_Absent_No_Cov = Staff_Absences_No_Covid_Perc * Number_Staff,
    Weights_Covid_Absences_By_Group = Num_Absent_Cov / sum(Num_Absent_Cov),
    Weights_No_Covid_Absences_By_Group =
      Num_Absent_No_Cov / sum(Num_Absent_No_Cov)
  ) %>%
  select(
    Group,
    Number_Staff,
    Num_Absent_Cov,
    Num_Absent_No_Cov,
    Staff_Absences_Covid_Perc,
    Weights_Covid_Absences_By_Group,
    Weights_No_Covid_Absences_By_Group
  )
```


```{r, Future Non Covid Absences}
daily_abs_dates <-
  seq(min(cov_long$date), params$end_date, by = "day")

daily_abs <-
  c(
    Daily_Absences_All_Staff$Staff_Absences_NoCovid_Perc,
    rep(
      tail(Daily_Absences_All_Staff$Staff_Absences_NoCovid_Perc, 1),
      length(daily_abs_dates) - nrow(Daily_Absences_All_Staff)
    )
  )

no_cov_abs <-
  data.frame(date = daily_abs_dates, no_cov_abs = daily_abs)

```

```{r}

combs <-
  expand.grid(group = unique(staff_weights$Group),
              model = unique(cov_long$name))

group_df <- data.frame()
for (i in 1:nrow(combs)) {
  group = combs$group[i]
  model = combs$model[i]
  
  staff_group <- staff_weights %>%
    filter(Group == group)
  
  cov_rates <- cov_long %>%
    filter(name == model)
  
  cov_staff_out <-
    sum(staff_weights$Number_Staff) * staff_group$Weights_Covid_Absences_By_Group * cov_rates$value
  
  no_cov_staff_out <-
    sum(staff_weights$Number_Staff) * staff_group$Weights_No_Covid_Absences_By_Group * no_cov_abs$no_cov_abs
  
  total_staff_out <- cov_staff_out + no_cov_staff_out
  
  num_staff <-  staff_group$Number_Staff
  group_out <- data.frame(
    date = cov_rates$date,
    group = group,
    model = model,
    cov_staff_out = cov_staff_out,
    no_cov_staff_out = no_cov_staff_out,
    total_staff_out = total_staff_out,
    num_staff = num_staff,
    cov_prop_staff_out = (cov_staff_out / num_staff) *
      100,
    no_cov_prop_staff_out = (no_cov_staff_out / num_staff) *
      100,
    total_prop_staff_out = (total_staff_out / num_staff) *
      100
  )
  
  group_df <- rbind(group_out, group_df)
}


```

```{r, warnings =FALSE}

#2 week lag - people returning after 2 weeks

lag <- 14

group_df_lag <- group_df %>%
  group_by(group, model) %>%
  mutate(
    nrows = n(),
    end_lag = nrows[1] - lag ,
    cov_staff_return = ifelse(nrows > lag, c(rep(0, lag), cov_staff_out[1:end_lag]), 0))


###############Only getting returners from 14days after last data point
group_df_lag$cov_staff_return <- ifelse(group_df_lag$date < first_date + lag, 0 ,group_df_lag$cov_staff_return)
###############

group_df_lag$cov_lag_staff_out <- group_df_lag$cov_staff_out - group_df_lag$cov_staff_return

group_df_lag$cov_lag_prop <- (group_df_lag$cov_lag_staff_out / group_df_lag$num_staff) * 100

group_df_lag$total_staff_out <- group_df_lag$cov_lag_staff_out + group_df_lag$no_cov_staff_out

group_df_lag$total_prop_staff_out <- (group_df_lag$total_staff_out / group_df_lag$num_staff) * 100

group_df_lag <- group_df_lag %>% 
  select(
    date,
    group,
    model,
    cov_staff_out,
    cov_lag_staff_out,
    cov_staff_return,
    no_cov_staff_out,
    total_staff_out,
    cov_prop_staff_out,
    cov_lag_prop,
    no_cov_prop_staff_out,
    total_prop_staff_out
  )


```


```{r}

write.csv(group_df_lag, paste0("C:/Users/Fiona/Documents/ECEHH/COVID/Outputs/",params$hospital,"_",format(Sys.Date(), "%Y%m%d"), "_absences_data.csv"), row.names = FALSE)

```


```{r Date for group plots}
num_pl_df <- data.frame(group_df_lag %>% 
  select(date, group, model,total_staff_out, cov_lag_staff_out) %>% 
  pivot_longer(., cols = c("total_staff_out", "cov_lag_staff_out"))) %>% mutate(model = factor(model, levels = c("Nat75", "Dev50", "Dev2.5", "Dev97.5")))

```



```{r Data for all staff plots}
all_staff<- data.frame(num_pl_df %>% 
              group_by(date, model, name) %>% 
              summarise(value = sum(value)) %>%               
              select(date, model,  name, value) %>% 
              ungroup())
```



```{r Total staff absent due to COVID}

ymax <- ifelse(max(all_staff$value)> staff_num, staff_num, NA)


all_staff_plot_cov <- ggplot(all_staff %>% filter(date > as.Date("2020-03-19")& name == "cov_lag_staff_out"),aes(x = date, y = value, col = model, group = interaction(model,name)))+
  geom_line(aes(linetype = model, size = model)) +
  geom_point(data = all_staff %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "cov_lag_staff_out") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
  ylab("Number Staff Absent")+
  xlab("Date")+
  scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  theme(legend.title = element_blank()) +
  ggtitle(paste0("Staff Numbers Absent due to COVID-19 - ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  theme_bw() +
  theme(text = element_text(size=20))+
  ylim(0,ymax)

```



\newpage
```{r, echo = FALSE}


png(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Numbers_All_Staff.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(all_staff_plot_cov)
invisible(dev.off())

# ggsave(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Numbers_All_Staff.png"), width = 30, height = 20, units = "cm")

```


```{r Total staff absences}

all_staff_plot_total <- ggplot(all_staff %>% filter(date > as.Date("2020-03-19")& name == "total_staff_out"),aes(x = date, y = value, col = model, group = interaction(model,name)))+
  geom_line(aes(linetype = model, size = model)) +
  geom_point(data = all_staff %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "total_staff_out") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
  ylab("Number Staff Absent")+
  xlab("Date")+
  scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  theme(legend.title = element_blank()) +
  ggtitle(paste0("Staff Numbers Absent (All) - ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  theme_bw() +
  theme(text = element_text(size=20))+
  ylim(0,ymax)


all_staff_plot_cov/all_staff_plot_total



```

```{r, echo =FALSE}


png(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Numbers_All_Staff.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(all_staff_plot_total)
invisible(dev.off())

# ggsave(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Numbers_All_Staff.png"), width = 30, height = 20, units = "cm")
```


```{r Proportion plot data preparation}

prop_pl_df <- group_df_lag %>% 
  select(date, group, model,total_prop_staff_out, cov_lag_prop, no_cov_prop_staff_out) %>% 
  pivot_longer(., cols = c("total_prop_staff_out", "cov_lag_prop")) 

prop_pl_df$model <- factor(prop_pl_df$model, levels = c("Nat75", "Dev50", "Dev2.5", "Dev97.5"))
```



```{r Total staff percentage absent due to COVID}
total_staff <- sum(Number_Staff_By_Group$Number_Staff[1:8])

all_staff$prop_value <- (all_staff$value /total_staff) *100


all_props_cov <- ggplot(all_staff %>% filter(date > as.Date("2020-03-19") & name == "cov_lag_staff_out"),aes(x = date, y = prop_value, col = model, group = interaction(model, name)))+
  geom_line(aes(linetype = model, size = model)) +
  geom_point(data = all_staff %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "cov_lag_staff_out") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
   ylab("Proportion Staff Absent %")+
  xlab("Date")+
  scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  theme(legend.title = element_blank()) +
  theme_bw()+
  theme(text = element_text(size=20))+
  ggtitle(paste0("Percentage Staff Absent due to COVID-19 - ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  ylim(0,100)

#all_props_cov




```


```{r, echo = FALSE}


png(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Proportions_All_Staff.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(all_props_cov)
invisible(dev.off())

# ggsave(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Proportions_All_Staff.png"), width = 30, height = 20, units = "cm")
```

```{r Total staff percentage absent}
total_staff <- sum(Number_Staff_By_Group$Number_Staff[1:8])

all_staff$prop_value <- (all_staff$value /total_staff) *100


all_props_tot <- ggplot(all_staff %>% filter(date > as.Date("2020-03-19") & name == "total_staff_out"),aes(x = date, y = prop_value, col = model, group = interaction(model, name)))+
  geom_line(aes(linetype = model, size = model)) +
  geom_point(data = all_staff %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "total_staff_out") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
   ylab("Proportion Staff Absent %")+
  xlab("Date")+
  scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  theme(legend.title = element_blank()) +
  theme_bw()+
  theme(text = element_text(size=20))+
  ggtitle(paste0("Percentage Staff Absent (All) - ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  ylim(0,100)

#all_props_tot



all_props_cov/all_props_tot

```


```{r, echo = FALSE}


png(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Proportions_All_Staff.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(all_props_tot)
invisible(dev.off())

# ggsave(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Proportions_All_Staff.png"), width = 30, height = 20, units = "cm")
```

```{r Group plot - covid numbers}

ymax <- ifelse(max(num_pl_df$value)> staff_num, staff_num, NA)

num_plot_cov <-
  ggplot(num_pl_df %>% 
           filter(date > as.Date("2020-03-19") & name == "cov_lag_staff_out"),
    aes(
      x = date,
      y = value,
      group = interaction(model, group)
    )
  ) +
  geom_line(aes(col = model, linetype = model, size = model)) +
  geom_point(data = num_pl_df %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "cov_lag_staff_out") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
  facet_wrap( ~ group) +
  ylab("Number Staff Absent") +
  xlab("Date") +
  theme(legend.title = element_blank()) +
  ggtitle(paste0("Staff Numbers Absent due to COVID-19 - ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  theme_bw()+
  scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  theme(text = element_text(size=20))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  ylim(0,ymax)
 
num_plot_cov


```



```{r, echo = FALSE}


png(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Numbers_Staff_Groups.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(num_plot_cov)
invisible(dev.off())

# ggsave(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Numbers_Staff_Groups.png"), width = 30, height = 20, units = "cm")
```

```{r Group plot all absences}

num_plot_all <-
  ggplot(num_pl_df %>% 
           filter(date > as.Date("2020-03-19") & name == "total_staff_out"),
    aes(
      x = date,
      y = value,
      group = interaction(model, group)
    )
  ) +
  geom_line(aes(col = model, linetype = model, size = model)) +
  geom_point(data = num_pl_df %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "total_staff_out") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
  facet_wrap( ~ group) +
  ylab("Number Staff Absent") +
  xlab("Date") +
  scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  theme(legend.title = element_blank())+
  ggtitle(paste0("Staff Numbers Absent (All) - ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  theme_bw() +
  theme(text = element_text(size=20))+
  ylim(0,ymax)
 
num_plot_all



```

```{r, echo = FALSE}


png(paste0(params$out_dir,"/", params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Numbers_Staff_Groups.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(num_plot_all)
invisible(dev.off())

# ggsave(paste0(params$out_dir,"/", params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Numbers_Staff_Groups.png"), width = 30, height = 20, units = "cm")
```


```{r Group plot percentage staff absent due to COVID}
prop_plot_cov <- ggplot(prop_pl_df %>% filter(date > as.Date("2020-03-19") & name == "cov_lag_prop"),aes(x = date, y = value, col = model, group = interaction(model, group,name)))+
  geom_line(aes(col = model, linetype = model, size = model)) +
  geom_point(data = prop_pl_df %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "cov_lag_prop") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
  facet_wrap(~group)+
  ylab("Proportion Staff Absent %")+
  xlab("Date")+
 scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  theme(legend.title = element_blank()) +
  theme_bw()+
  theme(text = element_text(size=20))+
  ggtitle(paste0("Percentage Staff Absent due to COVID-19 - ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  ylim(0,100)


prop_plot_cov



```


```{r, echo = FALSE}


png(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Proportions_Staff_Groups.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(prop_plot_cov)
invisible(dev.off())

# ggsave(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_COVID_Absences_Proportions_Staff_Groups.png"), width = 30, height = 20, units = "cm")
```


```{r Group plot all staff absences}

prop_plot_all <- ggplot(prop_pl_df %>% filter(date > as.Date("2020-03-19") & name == "total_prop_staff_out"),aes(x = date, y = value, col = model, group = interaction(model, group,name)))+
  geom_line(aes(col = model, linetype = model, size = model)) +
  geom_point(data = prop_pl_df %>% filter(date > as.Date("2020-03-19") & date <= first_date & name == "total_prop_staff_out") , col = "black") +
  geom_vline(xintercept = first_date, linetype = "dotted") +
  facet_wrap(~group)+
  ylab("Proportion Staff Absent %")+
  xlab("Date")+
 scale_color_manual(values = c("#00BFC4",rep("#F8766D", 3))) +
  scale_linetype_manual(values = c("solid", "solid", "dotted", "dotted"))+
  scale_size_manual(values = c(1.5,1.5,1,1))+
  theme(legend.title = element_blank()) +
  theme_bw()+
  theme(text = element_text(size=20))+
  ggtitle(paste0("Percentage Staff Absent (All)- ", params$hospital))+
  labs(color = "", size = "", linetype= "")+
  ylim(0,100)


prop_plot_all


```


```{r, echo = FALSE}


png(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Proportions_Staff_Groups.png"), width = params$fig_width, height = params$fig_height, units = "in",res = params$image_ppi)
print(prop_plot_all)
invisible(dev.off())

# 
# ggsave(paste0(params$out_dir,"/",params$hospital, "_",format(Sys.Date(), "%Y%m%d"),"_All_Absences_Proportions_Staff_Groups.png"), width = 30, height = 20, units = "cm")

```

